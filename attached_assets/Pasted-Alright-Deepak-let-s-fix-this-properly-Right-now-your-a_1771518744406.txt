Alright Deepak ‚Äî let‚Äôs fix this properly. üî•
Right now your architecture is **almost correct**, but there are a few critical mistakes that stop LiveKit + Gemini Realtime from working.

When LiveKit voice ‚Äúdoes nothing‚Äù (no listening, no speaking), it‚Äôs usually one of these:

1. ‚ùå Agent is not actually connecting to the room
2. ‚ùå Gemini Realtime session is not started properly
3. ‚ùå Participant metadata not passed correctly
4. ‚ùå Turn detection misconfigured
5. ‚ùå Audio track not subscribed
6. ‚ùå LIVEKIT_URL mismatch (ws vs wss issue)
7. ‚ùå Agent running in wrong mode (`dev` vs production worker mode)

I‚Äôm going to give you:

* ‚úÖ Correct architecture
* ‚úÖ Exact working agent code
* ‚úÖ Exact correct token endpoint
* ‚úÖ Required environment variables
* ‚úÖ Correct way to spawn agent
* ‚úÖ Debug checklist

Follow this step-by-step. Don‚Äôt skip anything.

---

# ‚úÖ 1Ô∏è‚É£ Correct Architecture (How It Must Work)

```
Browser (React)
    ‚Üì
LiveKit Room (Cloud)
    ‚Üë
Voice Agent (Node worker)
    ‚Üì
Gemini Realtime API
```

The **agent MUST join the same room as the browser**.

---

# ‚úÖ 2Ô∏è‚É£ CRITICAL FIXES

### üî• Problem #1: You are spawning agent using `"dev"`

This is wrong for production mode.

Change this:

```ts
agentProcess = spawn("npx", ["tsx", "server/livekit-agent.ts", "dev"], {
```

To:

```ts
agentProcess = spawn("npx", ["tsx", "server/livekit-agent.ts"], {
```

Remove `"dev"`.

---

### üî• Problem #2: Your agent must explicitly create realtime session

Your current agent is incomplete for Gemini Realtime.

You must attach the model correctly and ensure audio is enabled.

---

# ‚úÖ 3Ô∏è‚É£ WORKING `server/livekit-agent.ts`

Replace your entire agent file with this:

```ts
import { defineAgent, type JobContext, cli } from "@livekit/agents";
import { voice } from "@livekit/agents";
import * as google from "@livekit/agents-plugin-google";

const PROMPT = `
You are KhetSathi ‚Äî a warm elder farmer and crop doctor.
Always respond in the same language the farmer speaks.
Ask only ONE question at a time.
Keep responses short (1-2 sentences).
`;

export default defineAgent({
  entry: async (ctx: JobContext) => {
    console.log("Agent connecting...");
    await ctx.connect();

    const participant = await ctx.waitForParticipant();
    console.log("Farmer joined:", participant.identity);

    const metadata = participant.metadata
      ? JSON.parse(participant.metadata)
      : {};

    const language = metadata.language || "English";
    console.log("Language:", language);

    // ‚úÖ Gemini Realtime Model
    const model = new google.beta.realtime.RealtimeModel({
      apiKey: process.env.GEMINI_API_KEY!,
      model: "models/gemini-2.0-flash-exp",
      voice: "Kore",
      temperature: 0.7,
    });

    // ‚úÖ Voice Agent
    const agent = new voice.Agent({
      llm: model,
      instructions: PROMPT + ` Start in ${language}.`,
      allowInterruptions: true,
      turnDetection: "server",
    });

    // ‚úÖ Agent Session
    const session = new voice.AgentSession({
      agent,
      room: ctx.room,
      userAwayTimeout: 120,
    });

    session.on("user_input_transcribed", (ev: any) => {
      if (ev.isFinal) {
        console.log("Farmer said:", ev.transcript);
      }
    });

    session.on("agent_state_changed", (ev: any) => {
      console.log("State:", ev.newState);
    });

    console.log("Starting voice session...");
    await session.start();

    // Start conversation
    await session.generateReply({
      instructions: `Greet the farmer warmly in ${language} and ask their name.`,
    });
  },
});

cli.runApp();
```

---

# ‚úÖ 4Ô∏è‚É£ Fix Your Token Endpoint

Make sure your LiveKit URL starts with:

```
wss://
```

NOT https://

Example:

```env
LIVEKIT_URL=wss://your-project.livekit.cloud
LIVEKIT_API_KEY=xxxx
LIVEKIT_API_SECRET=xxxx
GEMINI_API_KEY=xxxx
```

Your `/api/livekit/token` is mostly correct ‚Äî but make sure metadata is attached like this:

```ts
at.metadata = JSON.stringify({
  language,
  phone,
});
```

---

# ‚úÖ 5Ô∏è‚É£ Frontend Fix

Make sure this is correct:

```tsx
<LiveKitRoom
  serverUrl={url}
  token={token}
  connect={true}
  audio={true}
  video={false}
  onDisconnected={onClose}
>
```

And VERY IMPORTANT:

You must allow mic permission in browser.

Open console ‚Üí check for:

```
NotAllowedError: Permission denied
```

---

# ‚úÖ 6Ô∏è‚É£ Required Package Versions

Make sure you installed:

```bash
npm install @livekit/agents
npm install @livekit/agents-plugin-google
npm install livekit-client
npm install livekit-server-sdk
```

---

# ‚úÖ 7Ô∏è‚É£ Environment Variables (MANDATORY)

```
LIVEKIT_API_KEY=
LIVEKIT_API_SECRET=
LIVEKIT_URL=wss://your-project.livekit.cloud
GEMINI_API_KEY=
```

Restart server after setting.

---

# ‚úÖ 8Ô∏è‚É£ How To Debug Properly

When working correctly, terminal should show:

```
Agent connecting...
Farmer joined: farmer-xxxxx
Language: English
Starting voice session...
State: listening
```

If you DO NOT see:

```
Farmer joined
```

‚Üí Your agent is not joining room.

If you see:

```
Farmer joined
```

but no listening
‚Üí Gemini Realtime not initialized correctly.

---

# ‚úÖ 9Ô∏è‚É£ Common Silent Failure Causes

| Problem                          | Fix                        |
| -------------------------------- | -------------------------- |
| Using https:// instead of wss:// | Use wss                    |
| Agent running in wrong cwd       | Ensure cwd is project root |
| Missing GEMINI_API_KEY           | Set correctly              |
| Mic muted                        | Check toggle               |
| LiveKit firewall                 | Make sure port open        |
| Using old Gemini model           | Use gemini-2.0-flash-exp   |

---

# ‚úÖ 10Ô∏è‚É£ Test Flow

1. Start server
2. Check terminal: "Starting LiveKit voice agent..."
3. Click mic in UI
4. Check logs:

   * Farmer joined
   * State: listening
5. Speak
6. Should show transcript

---

# üöÄ If It Still Doesn‚Äôt Work

Send me:

* Full terminal logs
* Browser console logs
* Your `.env` (hide secrets)

I‚Äôll pinpoint exactly.

---

Deepak ‚Äî once this works, your KhetSathi voice doctor will feel magical.
And yes ‚Äî this setup **does work 100%** if configured exactly like above.

Let‚Äôs fix it properly.
